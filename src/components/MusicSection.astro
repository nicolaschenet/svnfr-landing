---
// Music Section component
import { featuredRelease } from "../data/releases.js";

// Function to compute darker variants of the accent color
function getDarkerShade(color: string, opacity: number): string {
  const hexToRgb = (hex: string) => {
    const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    const fullHex = hex.replace(
      shorthandRegex,
      (m: string, r: string, g: string, b: string) => r + r + g + g + b + b
    );
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(fullHex);
    return result
      ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16),
        }
      : null;
  };

  const rgb = hexToRgb(color);
  if (!rgb) return `rgba(17, 17, 17, ${opacity})`;

  // Make a dark shade by reducing RGB values to 15-25% of original
  const darkR = Math.floor(rgb.r * 0.15);
  const darkG = Math.floor(rgb.g * 0.15);
  const darkB = Math.floor(rgb.b * 0.2);

  return `rgba(${darkR}, ${darkG}, ${darkB}, ${opacity})`;
}

// Function to compute a very light version of the accent color (for text)
function getLightAccentTint(color: string): string {
  const hexToRgb = (hex: string) => {
    const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    const fullHex = hex.replace(
      shorthandRegex,
      (m: string, r: string, g: string, b: string) => r + r + g + g + b + b
    );
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(fullHex);
    return result
      ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16),
        }
      : null;
  };

  const rgb = hexToRgb(color);
  if (!rgb) return "rgba(255, 255, 255, 0.95)";

  // Calculate perceived brightness (using the formula from WCAG)
  // Luminance = 0.2126*R + 0.7152*G + 0.0722*B
  const luminance = (0.2126 * rgb.r + 0.7152 * rgb.g + 0.0722 * rgb.b) / 255;

  let textR, textG, textB;

  if (luminance < 0.5) {
    // Dark accent color - create a light tint
    // Calculate a color that's 90% white, 10% accent
    textR = Math.floor(255 * 0.9 + rgb.r * 0.1);
    textG = Math.floor(255 * 0.9 + rgb.g * 0.1);
    textB = Math.floor(255 * 0.9 + rgb.b * 0.1);
  } else {
    // Light accent color - create a dark tint
    // Calculate a color that's 90% black, 10% accent
    textR = Math.floor(0 * 0.9 + rgb.r * 0.1);
    textG = Math.floor(0 * 0.9 + rgb.g * 0.1);
    textB = Math.floor(0 * 0.9 + rgb.b * 0.1);
  }

  return `rgb(${textR}, ${textG}, ${textB})`;
}

// Generate dark versions of the accent color
const darkAccent = getDarkerShade(featuredRelease.accentColor, 0.95);
const darkerAccent = getDarkerShade(featuredRelease.accentColor, 0.85);

// Ensure we have a brighter version of the accent color for better contrast
const brighterAccent = featuredRelease.accentColor;

// Generate light tint of accent color for text
const lightAccentTint = getLightAccentTint(featuredRelease.accentColor);
---

<section id="music" class="section">
  <h2>Music</h2>
  <div
    class="featured-release"
    id="featured-release"
    style={`
      --accent-color: ${featuredRelease.accentColor};
      --accent-color-transparent: ${featuredRelease.accentColor}33;
      --accent-color-glow: ${featuredRelease.accentColor}11;
      --accent-color-highlight: ${brighterAccent};
      --dark-accent: ${darkAccent};
      --darker-accent: ${darkerAccent};
      --light-accent-tint: ${lightAccentTint};
    `}
  >
    <h3>{featuredRelease.title}</h3>
    <p>
      <strong>
        {featuredRelease.released ? "Release date:" : "Releasing:"}
      </strong>
      {featuredRelease.releaseDate}
    </p>

    {
      featuredRelease.released && (
        <div class="flex gap-4 mb-6">
          <a
            href={featuredRelease.links.spotify}
            target="_blank"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-white/[0.09] text-white text-xl transition-all duration-200 ease-in-out hover:bg-white/[0.15] hover:-translate-y-1"
            aria-label="Listen on Spotify"
          >
            <i class="fa-brands fa-spotify" />
          </a>
          <a
            href={featuredRelease.links.appleMusic}
            target="_blank"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-white/[0.09] text-white text-xl transition-all duration-200 ease-in-out hover:bg-white/[0.15] hover:-translate-y-1"
            aria-label="Listen on Apple Music"
          >
            <i class="fa-brands fa-apple" />
          </a>
          <a
            href={featuredRelease.links.bandcamp}
            target="_blank"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-white/[0.09] text-white text-xl transition-all duration-200 ease-in-out hover:bg-white/[0.15] hover:-translate-y-1"
            aria-label="Buy on Bandcamp"
          >
            <i class="fa-brands fa-bandcamp" />
          </a>
          <a
            href={featuredRelease.links.hyperfollow}
            target="_blank"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-white/[0.09] text-white text-xl transition-all duration-200 ease-in-out hover:bg-white/[0.15] hover:-translate-y-1"
          >
            <i class="fa-solid fa-headphones" />
          </a>
        </div>
      )
    }

    <p>
      {featuredRelease.description}
    </p>

    {
      featuredRelease.released && featuredRelease.links.spotify && (
        <div class="spotify-embed mt-8">
          <iframe
            style="border-radius:12px"
            src={`https://open.spotify.com/embed/album/${featuredRelease.links.spotify.split("/album/")[1].split("?")[0]}`}
            width="100%"
            height="352"
            allowfullscreen=""
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
            loading="lazy"
          />
        </div>
      )
    }

    {
      !featuredRelease.released && (
        <div class="mt-16 text-center">
          <h4 class="text-white/70 tracking-[2px] uppercase text-xs mb-8">
            GET NOTIFIED ON RELEASE
          </h4>
          <div class="flex justify-center gap-8 flex-wrap">
            <a
              href={featuredRelease.links.hyperfollow}
              target="_blank"
              class="inline-flex items-center justify-center py-3 px-6 bg-black/60 text-white border rounded no-underline text-sm font-medium tracking-wide transition-all duration-300 overflow-hidden uppercase mb-4 bg-gradient-to-br from-purple-900/50 to-purple-800/30 border-purple-500/30 hover:bg-black/75 hover:-translate-y-0.5  hover:from-purple-900/60 hover:to-purple-800/40 hover:border-purple-500/40"
            >
              <i class="fa-solid fa-headphones mr-2" />
              Pre-save on All Platforms
            </a>

            {featuredRelease.links.bandcamp && (
              <a
                href={featuredRelease.links.bandcamp}
                target="_blank"
                class="inline-flex items-center justify-center py-3 px-6 bg-black/60 text-white border  rounded no-underline text-sm font-medium tracking-wide transition-all duration-300 overflow-hidden uppercase mb-4 bg-gradient-to-br from-teal-900/50 to-teal-800/30 border-teal-500/30 hover:bg-black/75 hover:-translate-y-0.5  hover:from-teal-900/60 hover:to-teal-800/40 hover:border-teal-500/40"
              >
                <i class="fa-brands fa-bandcamp mr-2" />
                Pre-order on Bandcamp
              </a>
            )}
          </div>
        </div>
      )
    }
  </div>
</section>

<style>
  /* Custom styling for the featured release container */
  .featured-release {
    position: relative;
    border-radius: 0.75rem;
    padding: 3rem;
    margin-bottom: 3rem;
    overflow: hidden;
    background-color: var(--dark-accent);
    background-image: linear-gradient(
        to bottom right,
        var(--darker-accent),
        var(--dark-accent)
      ),
      linear-gradient(to bottom, transparent, var(--accent-color-glow));
    border: 1px solid var(--accent-color-transparent);
    box-shadow:
      0 10px 30px rgba(0, 0, 0, 0.5),
      0 0 30px var(--accent-color-glow);
    transition:
      border-color 0.3s ease,
      box-shadow 0.3s ease;
  }

  .featured-release::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    background: linear-gradient(
      45deg,
      transparent 0%,
      var(--accent-color-glow) 50%,
      transparent 100%
    );
  }

  .featured-release h3 {
    font-size: 2.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--accent-color-highlight);
    text-shadow:
      0 0 10px var(--accent-color-glow),
      0 0 2px rgba(0, 0, 0, 0.8);
    letter-spacing: 0.025em;
  }

  .featured-release p {
    color: var(--light-accent-tint);
    margin-bottom: 1rem;
    font-size: 1.125rem;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    line-height: 1.6;
    position: relative;
    z-index: 1;
  }

  .featured-release p strong {
    color: white;
    font-weight: 600;
  }

  /* Improved contrast for links inside paragraphs */
  .featured-release p a {
    color: var(--accent-color-highlight);
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.2s ease;
  }

  .featured-release p a:hover {
    color: white;
  }

  /* Better visibility for social media links */
  .featured-release .flex a {
    color: var(--light-accent-tint);
  }

  .featured-release .flex a:hover {
    background-color: rgba(255, 255, 255, 0.15);
    color: var(--accent-color-highlight);
  }

  /* Remove the semi-transparent background styling */
  /* Add a subtle semi-transparent background behind text for better readability */
  .featured-release p {
    background-color: transparent;
    padding: 0;
    border-radius: 0;
    margin-left: 0;
    margin-right: 0;
    width: auto;
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .featured-release {
      padding: 2rem;
    }

    .featured-release h3 {
      font-size: 1.75rem;
    }

    .featured-release p {
      font-size: 1rem;
      margin-left: 0;
      margin-right: 0;
      width: auto;
    }
  }
</style>
